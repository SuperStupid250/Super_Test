

<html><head>
<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Hub Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.3.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>


<link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/css/bootstrap4-toggle.min.css" rel="stylesheet">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/js/bootstrap4-toggle.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="/assets/style/common.css">
</head><body><header class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"></header>
<div class="container-fluid">
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page">Nodes on PAN</li>
  </ol>
</nav>
<h2>Nodes Information</h2>
<div class="card bg-light mb-3" style="max-width: 72rem;">
  <div class="card-header">Nodes List</div>
  <div class="card-body">
    <table class="table table-sm">
      <thead>
        <tr>
          <th scope="col">SN#</th>
          <th scope="col">Nwk Addr</th>
          <th scope="col">Battery</th>
          <th scope="col">Signal</th>
          <th scope="col" style="">Online</th>
          <th scope="col" style="">Last Seen</th>
          <th scope="col" style="">Version</th>
          <th scope="col" style="">Model</th>
          <th scope="col" style="">Alias</th>
          <th scope="col" style="">Storage</th>
        </tr>
      </thead>
      <tbody>
      <tr><td scope="row">00124B0023AC<b class="text-success">F54C</b></td>
<td>1C0D</td><td>100%</td><td>30%</td><td><span class="text-warning oi oi-clock"></span></td><td>20 hours 10 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">F568</b></td>
<td>1C17</td><td>100%</td><td>40%</td><td><span class="text-warning oi oi-clock"></span></td><td>1 days 14 hours ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">FAAB</b></td>
<td>1C0C</td><td>90%</td><td>40%</td><td><span class="text-warning oi oi-clock"></span></td><td>20 hours 10 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">FAC2</b></td>
<td>1C1C</td><td>100%</td><td>20%</td><td><span class="text-warning oi oi-clock"></span></td><td>18 hours 35 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">FAB1</b></td>
<td>1C05</td><td>90%</td><td>30%</td><td><span class="text-warning oi oi-clock"></span></td><td>18 hours 40 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">F55A</b></td>
<td>1C1A</td><td>100%</td><td>40%</td><td><span class="text-warning oi oi-clock"></span></td><td>1 days 1 hours ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">F576</b></td>
<td>1C10</td><td>100%</td><td>40%</td><td><span class="text-warning oi oi-clock"></span></td><td>18 hours 41 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">FAF1</b></td>
<td>1C0E</td><td>100%</td><td>30%</td><td><span class="text-warning oi oi-clock"></span></td><td>20 hours 26 minutes ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr><tr><td scope="row">00124B0023AC<b class="text-success">F7B8</b></td>
<td>1C15</td><td>100%</td><td>Unknown</td><td><span class="text-warning oi oi-clock"></span></td><td>2 days 18 hours ago</td><td>v1.67J</td><td>2.9-Inch (B+W+C, PA)</td><td></td><td>0&percnt; used</td></tr>
      </tbody>
    </table>
  <div id="pj" class="alert" role="alert"></div>
  <div class="mb-2" style=""><small class='text-muted'>Nodes will be marked as offline when no-show for 5400 seconds.<small></div>
  <button type="button" class="btn btn-primary" id="btnPermitJoin">Allow Node(s) Pairing with This Hub</button>
  <button type="button" style="" class="btn btn-primary" id="btnNodeOTA" onclick="checkUpdate7in5()" data-toggle='modal' data-target='#emu' >Check Update(for 7.5 inch displays)</button>
  </div>
</div>

<script>
$(document).ready(function(){
  var joinPeroid = 60
  permitJoin = function(){
    data = {
      'join' : joinPeroid,
    }
    htmlobj = $.ajax({
      url:"/pan/permit_join",
      type : 'POST',
      data : data,
      dataType : "json",
      async : true,
      success : function(data) {
        $("#btnPermitJoin").prop('disabled', true)
        console.log(data)
        $('#pj').addClass('alert-success').html(data['msg'])
        cnt = joinPeroid
        var timeoutID = setInterval(function(){
            cnt--;
            if (!cnt) {
              $("#btnPermitJoin").prop('disabled', false)
              clearInterval(timeoutID);
              $('#pj').html('Pairing session ended. Refresh this page to see the results.');
            } else
              $('#pj').html('Node(s) can pair with this hub now. Please set them to the pairing mode (' + cnt + 's)');
        }, 1000);
      },
      error : function() {
        $('#pj').addClass('alert-danger').html('Cannot start pairing.')
      }
    });
  }
  $("#btnPermitJoin").click(permitJoin)
})
</script>
<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="cdl" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">Confirm</div>
      <div class="modal-body">Remove this file from node's storage?</div>
      <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger btn-ok" data-dismiss="modal" id="go_del">Delete</a>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="em" tabindex="-1" role="dialog" aria-labelledby="eml" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eml">Storage on Display Node: <span id="nid"></span></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="tb"></div>
        <table class="display table table-bordered" id="nodeFiles"></table>
        <div id="ar" class="alert mt-1" role="alert"></div>
        <input id='xnid' type='hidden' value=""/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="emu" tabindex="-1" role="dialog" aria-labelledby="eml" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eml">Check Update (for 7.5 inch displays)<span id="nid"></span></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="tbl">Checking for new firmware...</div>
        <table class="display table table-bordered" id="nodeFiles"></table>
        <div id="ar2" class="alert mt-1" role="alert"></div>
        <input id='xnid' type='hidden' value=""/>
      </div>
    <form id='cuf' action='/ota/node/run' method='POST' hidden="true">
      <div class="modal-body">
          <div class="form-group">
            <label for="node">Select a node to update</label>
            <select class="form-control" id="node75" name="node"></select>
          </div>
          <div id="ar1" class="alert" role="alert"></div>
      </div>
      <div id="ha" class="alert alert-warning mt-3" role="alert">
        <span class="badge badge-pill badge-warning">Note</span>
        <ul>
        <li>This Hub must have been configured with a valid <a href="/setup/wifi">Wi-Fi settings</a>, since the display will download the firmware through the same Wi-Fi hotspot.</li>
        <li>It is strongly recommended that you keep the display charging during the upgrade process.</li>
        <li>When installing, your display will become unresponsive for a short while.</li>
        </ul>
      </div>
      <div class="modal-footer" >
        <button type="submit id="update-btn" class="btn btn-primary" onclick="update7in5()">Update Now</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </form>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.15.3/dist/bootstrap-table.min.css">
<script src="https://unpkg.com/bootstrap-table@1.15.3/dist/bootstrap-table.min.js"></script>
<script>
function operateFormatter(value, row, index) {
  return [
    '<a class="sh" href="javascript:void(0)">',
    'Show',
    '</a> ',
    '<a class="dl" href="javascript:void(0)">',
    'Delete',
    '</a>'
  ].join('')
}
window.operateEvents = {
  'click .sh': function (e, value, row, index) {
    nid = parseInt($('#xnid').val())
    console.log(nid, row.name)
    show_img(nid, row.name)
  },
  'click .dl': function (e, value, row, index) {
    nid = parseInt($('#xnid').val())
    console.log(nid, row.name)
    //$('#nodeFiles').modal('hide')
    $('#confirm-delete').modal('show')
    $("#go_del").attr("onclick","del_img(" + nid + ",'" + row.name + "')");
  },
}
$('#confirm-delete').on('show.bs.modal', function(e) {
    var zIndex = 1040 + (10 * $('.modal:visible').length) + 1;
    console.log('confirm del', zIndex)
    $(this).css('z-index', zIndex);
});
alertResult = function(cn, msg) {
  $('#ar').addClass(cn).html(msg).fadeTo(3000, 100).slideUp(500,function(){$("#ar").slideUp(500)});
}
load_stats = function(nodeId){
  $('#nodeFiles').bootstrapTable('destroy')
  $('#tb').removeClass('d-none').html('Loading...')
  data = {
    'node' : nodeId, // $("#node").val(),
  }
  htmlobj = $.ajax({
    url:"/display/disk/stats",
    type : 'POST',
    data : data,
    dataType : "json",
    async : true,
    success : function(ret) {
      $('#tb').addClass('d-none')
      $('#nodeFiles').bootstrapTable({
        data: ret.data,
        columns: [
          {
            title: 'Action',
            field: 'operate',
            events: window.operateEvents,
            formatter: operateFormatter
          },
          {
            title: 'File Name',
            field: 'name'
          },
          {
            title: 'Size',
            field: 'size'
          },
          {
            title: 'Offset',
            field: 'offset'
          },
          {
            title: 'Hash (SHA256)',
            field: 'hash'
          }
        ]
      });
    },
    error : function() {
      alertResult('alert-danger', 'Failed to load storage stats')
    }
  });
}
$('#em').on('show.bs.modal',function (event){
  var button = $(event.relatedTarget)
  var nodeId = button.data('node'); console.log(nodeId)
  load_stats(nodeId)
  var modal = $(this)
  modal.find('#nid').text(nodeId.toString(16).toUpperCase())
  modal.find('#xnid').val(nodeId)
})
show_img = function(nodeId, fileName){
  alertResult('alert-success', 'Sending ' + fileName + ' to ' + nodeId.toString(16).toUpperCase() + '...')
  data = {
    'node' : nodeId,
    'fn' : fileName,
  }
  htmlobj = $.ajax({
    url:"/display/show/image",
    type : 'POST',
    data : data,
    dataType : "json",
    async : true,
    success : function(ret) {
      alertResult('alert-success', ret['msg'])
    },
    error : function() {
      alertResult('alert-danger', 'Failed to show image')
    }
  });
}
del_img = function(nodeId, fileName){
  alertResult('alert-success', 'Deleting ' + fileName + ' on ' + nodeId.toString(16).toUpperCase() + '...')
  data = {
    'node' : nodeId,
    'fn' : fileName,
  }
  htmlobj = $.ajax({
    url:"/display/disk/remove",
    type : 'POST',
    data : data,
    dataType : "json",
    async : true,
    success : function(ret) {
      alertResult('alert-success', ret['msg'])
      load_stats(nodeId)
    },
    error : function() {
      alertResult('alert-danger', 'Failed to remove image')
    }
  });
}
</script>
<script>
update7in5 = function(){
  $('#ar1').addClass('alert-success').html('OTA instruction sent to display, awaiting confirmation')
}
checkUpdate7in5 = function(){
  data = {
  }
  htmlobj = $.ajax({
    url:"/ota/node/check",
    type : 'GET',
    data : data,
    dataType : "json",
    async : true,
    success : function(ret) {
      if (ret.code == 0) {
        $('#tbl').html('All 7.5 inch model nodes are at the latest version ('+ ret.newVersion +').')
      } else if (ret.code == 1) {
        $('#tbl').html('New firmware available (' + ret.newVersion + ')!')
        $('#cuf').removeAttr('hidden')
        $('#node75').html(ret.data)
      } else {
        $('#ar2').addClass('alert-danger').html('Failed to check for update')
        $('#tbl').html('')
      }
    },
    error : function() {
      $('#ar2').addClass('alert-danger').html('Failed to check for update')
      $('#tbl').html('')
    }
  });
}
</script>
</div></body></html>